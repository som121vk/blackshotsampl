<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blackshot - Login</title>
    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Outfit:wght@400;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
        body {
            background-color: #f0f2f5;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 450px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header .logo {
            font-size: 2rem;
            color: var(--primary-bg);
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            margin-bottom: 30px;
            background: #f8f9fa;
            padding: 5px;
            border-radius: 50px;
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s;
        }

        .tab.active {
            background: white;
            color: var(--primary-bg);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #eee;
            border-radius: 10px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            border-color: var(--primary-bg);
            outline: none;
        }

        .btn-full {
            width: 100%;
            padding: 12px;
            font-size: 1.1rem;
        }

        .error-msg {
            color: #dc3545;
            text-align: center;
            margin-top: 10px;
            display: none;
            font-size: 0.9rem;
        }
    </style>
</head>

<body>

    <div class="login-container">
        <div class="login-header">
            <div class="logo">
                <i class="fas fa-rocket"></i> BLACKSHOT
            </div>
            <p style="color: #6c757d;">Welcome back! Please login to your account.</p>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('login')">Login</div>
            <div class="tab" onclick="switchTab('register')">Sign Up</div>
        </div>

        <!-- Login Form -->
        <div id="login-form">
            <div class="form-group">
                <label>Email Address</label>
                <input type="email" id="login-email" placeholder="john@example.com">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="login-password" placeholder="••••••••">
            </div>
            <button class="btn btn-primary btn-full" onclick="handleLogin()">Login</button>
        </div>

        <!-- Register Form -->
        <div id="register-form" style="display: none;">
            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="reg-name" placeholder="John Doe">
            </div>
            <div class="form-group">
                <label>Email Address</label>
                <input type="email" id="reg-email" placeholder="john@example.com">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="reg-password" placeholder="Create a password">
            </div>

            <!-- OTP Field (Hidden Initially) -->
            <div class="form-group" id="otp-group" style="display: none;">
                <label>Verification Code</label>
                <input type="text" id="reg-otp" placeholder="Enter 6-digit OTP" maxlength="6">
                <small style="color: #6c757d; font-size: 0.8rem;">(Check the alert box for code)</small>
            </div>

            <button id="btn-get-otp" class="btn btn-primary btn-full" onclick="initiateRegister()">Get Verification
                Code</button>
            <button id="btn-verify-reg" class="btn btn-primary btn-full" onclick="completeRegister()"
                style="display: none;">Verify & Sign Up</button>
        </div>

        <p class="error-msg" id="msg-box"></p>



        <div style="text-align: center; margin-top: 20px;">
            <a href="index.html" style="color: #6c757d; font-size: 0.9rem;">Back to Store</a>
        </div>
    </div>

    <script src="js/store.js"></script>
    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
        // --- EMAIL CONFIGURATION ---
        // 1. Go to https://www.emailjs.com/ and create a free account.
        // 2. Create a standardized email service (e.g., Gmail).
        // 3. Create a template with a variable {{otp}} and {{to_name}}.
        // 4. Paste your keys below:
        const EMAILJS_PUBLIC_KEY = "TnuGpXSoVGSo6TEwz"; // e.g., "user_123456"
        const EMAILJS_SERVICE_ID = "service_d8pio5d"; // e.g., "service_gmail"
        const EMAILJS_TEMPLATE_ID = "template_5x98sb6"; // e.g., "template_otp"

        (function () {
            // Initialize if key is present
            if (EMAILJS_PUBLIC_KEY !== "YOUR_PUBLIC_KEY") {
                emailjs.init(EMAILJS_PUBLIC_KEY);
            }
        })();
    </script>

    <script>
        function switchTab(tab) {
            const loginForm = document.getElementById('login-form');
            const regForm = document.getElementById('register-form');
            const tabs = document.querySelectorAll('.tab');
            const msg = document.getElementById('msg-box');
            msg.style.display = 'none';

            // Reset Register Form on switch
            if (tab === 'login') {
                resetRegisterForm();
            }

            if (tab === 'login') {
                loginForm.style.display = 'block';
                regForm.style.display = 'none';
                tabs[0].classList.add('active');
                tabs[1].classList.remove('active');
            } else {
                loginForm.style.display = 'none';
                regForm.style.display = 'block';
                tabs[0].classList.remove('active');
                tabs[1].classList.add('active');
            }
        }

        function resetRegisterForm() {
            document.getElementById('otp-group').style.display = 'none';
            document.getElementById('btn-get-otp').style.display = 'block';
            document.getElementById('btn-get-otp').textContent = 'Get Verification Code';
            document.getElementById('btn-get-otp').disabled = false;
            document.getElementById('btn-verify-reg').style.display = 'none';
            document.getElementById('reg-email').disabled = false;
            document.getElementById('reg-otp').value = '';
            generatedOTP = null;
        }

        function showMsg(text, isError) {
            const msg = document.getElementById('msg-box');
            msg.textContent = text;
            msg.style.color = isError ? '#dc3545' : '#198754';
            msg.style.display = 'block';
        }

        let generatedOTP = null;

        function initiateRegister() {
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-password').value;
            const btn = document.getElementById('btn-get-otp');

            if (!name || !email || !pass) {
                showMsg('Please fill all fields', true);
                return;
            }

            // Check if user exists
            if (Store.checkUserExists(email)) {
                showMsg('Email already registered. Please Login.', true);
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Sending...';

            // Generate OTP
            generatedOTP = Math.floor(100000 + Math.random() * 900000).toString();

            // --- SEND OTP via EmailJS ---
            if (EMAILJS_PUBLIC_KEY !== "YOUR_PUBLIC_KEY") {
                const params = {
                    to_name: name,
                    to_email: email,    // Primary
                    email: email,       // Common backup
                    recipient: email,   // Common backup
                    otp: generatedOTP,
                    message: `Your Blackshot verification code is ${generatedOTP}`
                };

                // Pass Public Key explicitly as 4th argument
                emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, params, EMAILJS_PUBLIC_KEY)
                    .then(function (response) {
                        console.log('SUCCESS!', response.status, response.text);
                        showOTPUI();
                    }, function (error) {
                        console.log('FAILED...', error);
                        alert(`Email Send Failed: ${JSON.stringify(error)}\n\nPlease check the email address and try again.`);

                        // Re-enable button to allow retry
                        btn.disabled = false;
                        btn.textContent = 'Get Verification Code';
                        document.getElementById('reg-email').disabled = false;
                    });
            } else {
                // If keys are not set, use alert (Dev Mode)
                setTimeout(() => {
                    alert(`(Dev Mode) Your Verification Code is: ${generatedOTP}\n\nTo setup real emails, configure EmailJS keys in login.html`);
                    showOTPUI();
                }, 1000);
            }
        }

        function showOTPUI() {
            showMsg('OTP Sent to your email!', false);
            document.getElementById('otp-group').style.display = 'block';
            document.getElementById('btn-get-otp').style.display = 'none';
            document.getElementById('btn-verify-reg').style.display = 'block';
            document.getElementById('reg-email').disabled = true;
        }

        function completeRegister() {
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-password').value;
            const otp = document.getElementById('reg-otp').value;

            if (otp !== generatedOTP) {
                showMsg('Invalid Verification Code', true);
                return;
            }

            const result = Store.registerUser(name, email, pass);
            if (result.success) {
                showMsg('Account created successfully! Redirecting...', false);
                setTimeout(() => {
                    const urlParams = new URLSearchParams(window.location.search);
                    const redirect = urlParams.get('redirect');
                    window.location.href = redirect ? redirect : 'account.html';
                }, 1000);
            } else {
                showMsg(result.message, true);
            }
        }

        function handleLogin() {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-password').value;

            if (!email || !pass) {
                showMsg('Please fill all fields', true);
                return;
            }

            const result = Store.validateUser(email, pass);
            if (result.success) {
                showMsg('Login successful! Redirecting...', false);
                setTimeout(() => {
                    const urlParams = new URLSearchParams(window.location.search);
                    const redirect = urlParams.get('redirect');
                    window.location.href = redirect ? redirect : 'account.html';
                }, 1000);
            } else {
                showMsg(result.message, true);
            }
        }
    </script>
</body>

</html>