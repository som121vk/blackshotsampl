<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment | Blackshot Toy Store</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>

    <!-- Header -->
    <header>
        <div class="container nav-wrapper">
            <div class="logo">
                <a href="index.html" style="text-decoration: none; color: inherit;">
                    <i class="fas fa-rocket"></i> BLACKSHOT
                </a>
            </div>
            <nav class="nav-links">
                <a href="index.html">Home</a>
                <a href="cart.html">Cart</a>
            </nav>
        </div>
    </header>

    <!-- Payment Content -->
    <section class="container payment-container">
        <h2 style="margin-bottom: 30px;">Payment</h2>

        <!-- Order Review -->
        <div class="admin-card" style="margin-bottom: 30px;">
            <h3 style="margin-bottom: 15px;">Order Review</h3>
            <div id="order-review"></div>
            <div class="summary-row total" style="margin-top: 15px;">
                <span>Total Amount</span>
                <span id="final-total">â‚¹0</span>
            </div>
        </div>

        <!-- Payment Method Selection -->
        <h3 style="margin-bottom: 15px;">Select Payment Method</h3>
        <div class="payment-methods">
            <div class="payment-method active" data-method="upi" onclick="selectPaymentMethod('upi')">
                <i class="fab fa-google-pay"></i>
                <div>UPI Payment</div>
            </div>
            <div class="payment-method" data-method="cod" onclick="selectPaymentMethod('cod')">
                <i class="fas fa-money-bill-wave"></i>
                <div>Cash on Delivery</div>
            </div>
        </div>

        <!-- UPI Payment Section -->
        <div class="payment-form" id="upi-form">
            <h3 style="margin-bottom: 20px;"><i class="fab fa-google-pay"></i> UPI Payment</h3>

            <div id="upi-qr-section" style="text-align: center; margin-bottom: 30px;">
                <!-- QR Code will be displayed here -->
            </div>

            <form id="upi-payment-form">
                <div class="form-group">
                    <label>UPI Transaction ID / UTR / Reference Number</label>
                    <input type="text" id="utr-number" required placeholder="Enter 12-digit UTR number">
                    <small style="color: var(--text-muted);">
                        After scanning the QR code and completing payment, enter the transaction reference number here.
                    </small>
                </div>

                <div class="form-group">
                    <label>Payment Screenshot (Optional)</label>
                    <input type="file" id="payment-screenshot" accept="image/*">
                    <small style="color: var(--text-muted);">
                        Upload a screenshot of your payment for faster verification.
                    </small>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 15px; margin-top: 20px;">
                    <i class="fas fa-check"></i> Submit for Verification
                </button>
            </form>

            <div
                style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #ffc107;">
                <strong><i class="fas fa-info-circle"></i> Important:</strong>
                <p style="margin: 5px 0 0 0; font-size: 0.9rem;">
                    Your order will be placed after admin verification of your payment. You will receive a confirmation
                    once approved.
                </p>
            </div>
        </div>

        <!-- COD Payment Section -->
        <div class="payment-form" id="cod-form" style="display: none;">
            <h3 style="margin-bottom: 20px;"><i class="fas fa-money-bill-wave"></i> Cash on Delivery</h3>

            <div
                style="background: #e8f5e9; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #4caf50;">
                <h4 style="margin-bottom: 10px; color: #2e7d32;">How COD Works:</h4>
                <ul style="margin: 10px 0; padding-left: 20px; color: var(--text-dark);">
                    <li style="margin-bottom: 8px;">You pay in cash when the order is delivered to your doorstep</li>
                    <li style="margin-bottom: 8px;">Our delivery partner will hand over your order after receiving
                        payment</li>
                    <li style="margin-bottom: 8px;">Please keep the exact amount ready for smooth delivery</li>
                </ul>
            </div>

            <div
                style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                <strong><i class="fas fa-info-circle"></i> Note:</strong>
                <p style="margin: 5px 0 0 0; font-size: 0.9rem;">
                    COD orders require admin confirmation before processing. You will be notified once your order is
                    confirmed.
                </p>
            </div>

            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="cod-terms" required style="width: auto;">
                    <span>I understand and agree to pay cash on delivery</span>
                </label>
            </div>

            <button class="btn btn-primary" style="width: 100%; padding: 15px;" onclick="processCOD()">
                <i class="fas fa-check"></i> Confirm COD Order
            </button>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <div class="container footer-content">
            <div class="footer-col">
                <h3>BLACKSHOT</h3>
                <p>Premium toy store for the modern family.</p>
            </div>
        </div>
    </footer>

    <script src="js/store.js"></script>
    <script>
        let selectedMethod = 'upi';

        document.addEventListener('DOMContentLoaded', () => {
            const cart = Store.getCart();

            if (cart.length === 0) {
                alert('Your cart is empty!');
                window.location.href = 'index.html';
                return;
            }

            renderOrderReview();
            displayUpiQrCode();
        });

        function renderOrderReview() {
            const cart = Store.getCart();
            const orderReview = document.getElementById('order-review');

            orderReview.innerHTML = cart.map(item => `
                <div class="order-item">
                    <span class="order-item-name">${item.name}</span>
                    <span class="order-item-qty">x${item.quantity}</span>
                    <span>${Store.formatPrice(item.price * item.quantity)}</span>
                </div>
            `).join('');

            const total = Store.getCartTotal();
            document.getElementById('final-total').textContent = Store.formatPrice(total);
        }

        function selectPaymentMethod(method) {
            selectedMethod = method;

            // Update active state
            document.querySelectorAll('.payment-method').forEach(el => {
                el.classList.remove('active');
            });
            document.querySelector(`[data-method="${method}"]`).classList.add('active');

            // Show corresponding form
            document.getElementById('upi-form').style.display = 'none';
            document.getElementById('cod-form').style.display = 'none';
            document.getElementById(`${method}-form`).style.display = 'block';
        }

        function displayUpiQrCode() {
            const upiSettings = Store.getUpiSettings();
            const qrSection = document.getElementById('upi-qr-section');

            if (!upiSettings.upiId || !upiSettings.qrCode) {
                qrSection.innerHTML = `
                    <div style="background: #f8d7da; padding: 20px; border-radius: 8px; color: #721c24; border: 1px solid #f5c6cb;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <p><strong>UPI Payment Not Configured</strong></p>
                        <p style="font-size: 0.9rem; margin-top: 5px;">Please use Cash on Delivery or contact admin.</p>
                    </div>
                `;
                return;
            }

            qrSection.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 12px; display: inline-block; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                    <p style="margin-bottom: 15px; font-weight: 600; color: var(--text-dark);">Scan QR Code to Pay</p>
                    <img src="${upiSettings.qrCode}" alt="UPI QR Code" style="max-width: 250px; border: 2px solid #ddd; border-radius: 8px;">
                    <p style="margin-top: 15px; font-size: 0.9rem; color: var(--text-muted);">
                        UPI ID: <strong>${upiSettings.upiId}</strong>
                    </p>
                    <p style="margin-top: 10px; font-size: 1.2rem; font-weight: 700; color: var(--primary-red);">
                        Amount: ${Store.formatPrice(Store.getCartTotal())}
                    </p>
                </div>
            `;
        }

        document.getElementById('upi-payment-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const btn = e.target.querySelector('button');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';

            const utrNumber = document.getElementById('utr-number').value;
            const screenshotInput = document.getElementById('payment-screenshot');

            let screenshot = null;
            if (screenshotInput.files && screenshotInput.files[0]) {
                screenshot = await toBase64(screenshotInput.files[0]);
            }

            // Get shipping info
            const shippingInfo = JSON.parse(localStorage.getItem('shipping_info') || '{}');

            // Create pending order
            const orderData = {
                items: Store.getCart(),
                total: Store.getCartTotal(),
                shippingInfo: shippingInfo,
                paymentMethod: 'UPI',
                utrNumber: utrNumber,
                screenshot: screenshot
            };

            const order = Store.addPendingOrder(orderData);

            // Clear cart
            Store.clearCart();

            // Store order ID and redirect
            localStorage.setItem('order_id', order.orderId);
            localStorage.setItem('payment_method', 'UPI (Pending Verification)');

            setTimeout(() => {
                window.location.href = 'success.html';
            }, 1000);
        });

        function processCOD() {
            const checkbox = document.getElementById('cod-terms');
            if (!checkbox.checked) {
                alert('Please accept the terms to proceed');
                return;
            }

            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

            // Get shipping info
            const shippingInfo = JSON.parse(localStorage.getItem('shipping_info') || '{}');

            // Create pending order for COD (also requires admin approval)
            const orderData = {
                items: Store.getCart(),
                total: Store.getCartTotal(),
                shippingInfo: shippingInfo,
                paymentMethod: 'Cash on Delivery',
                utrNumber: 'N/A - COD',
                screenshot: null
            };

            const order = Store.addPendingOrder(orderData);

            // Clear cart
            Store.clearCart();

            // Store order ID and redirect
            localStorage.setItem('order_id', order.orderId);
            localStorage.setItem('payment_method', 'Cash on Delivery (Pending Confirmation)');

            setTimeout(() => {
                window.location.href = 'success.html';
            }, 1000);
        }

        // Helper: File to Base64
        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
    </script>
</body>

</html>